<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto PostgreSQL</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="light-mode">
<header>
    <img src="{{ url_for('static', filename='img/sql.png') }}" style="width:50px; height:50px;">
    <div class="logo">PostgreSQL</div>
    <div class="theme-switch">
        <label class="switch">
            <input type="checkbox" id="theme-toggle">
            <span class="slider"></span>
        </label>
        <a href="https://github.com" target="_blank">
            <img src="{{ url_for('static', filename='img/git.png') }}" alt="GitHub" style="width:50px; height:50px;">
        </a>            
    </div>
</header>   
<main>
    <div class="content">
        <div class="steps-container">
            <h1>Ingrese su código SQL</h1>
    <br>
    <br>
    <form id="form-codigo1">
        <textarea name="codigo1" placeholder="Ingrese create database 'nombre' " class="step-input textarea" required></textarea>
        <button type="button" class="btn enviar" onclick="enviarParte('codigo1')">Enviar</button>
        <button type="button" class="btn borrar" onclick="borrarParte('codigo1')">Borrar</button>
        <div id="notificacion-codigo1" class="notificacion"></div>
    </form>
    <br>
    
    <form id="form-codigo2">
        <textarea name="codigo2" placeholder="Ingrese el código para crear una tabla 'create table valores'" class="step-input textarea" required></textarea>
        <button type="button" class="btn enviar" onclick="enviarParte('codigo2')">Enviar</button>
        <button type="button" class="btn borrar" onclick="borrarParte('codigo2')">Borrar</button>
        <div id="notificacion-codigo2" class="notificacion"></div>
    </form>
    <br>
    
    <form id="form-codigo3">
        <textarea name="codigo3" placeholder="Ingrese el código para ingresar datos 'insert into nombre_tabla'" class="step-input textarea" required></textarea>
        <button type="button" class="btn enviar" onclick="enviarParte('codigo3')">Enviar</button>
        <button type="button" class="btn borrar" onclick="borrarParte('codigo3')">Borrar</button>
        <div id="notificacion-codigo3" class="notificacion"></div>
    </form>
    <br>
    
    <form id="form-codigo4">
        <textarea name="codigo4" placeholder="Ingrese el código SQL - Parte 4" class="step-input textarea" required></textarea>
        <button type="button" class="btn enviar" onclick="enviarParte('codigo4')">Enviar</button>
        <button type="button" class="btn borrar" onclick="borrarParte('codigo4')">Borrar</button>
        <div id="notificacion-codigo4" class="notificacion"></div>
    </form>
    <br>
            
            <!-- Mostrar el cuadro blanco con el texto completo si existe -->
            {% if texto_completo %}
    <div id="cuadro-blanco" class="cuadro-blanco">
        <h2>Código Completo:</h2>
        <pre id="texto-completo">{{ texto_completo }}</pre>
        <!-- Botones dentro del cuadro blanco -->
        <div class="button-container">
            <button type="button" class="btn analizar" onclick="analizarCodigo()">Analizar</button>
            <button type="button" class="btn borrar" onclick="borrarScript()">Borrar</button>
            <button type="button" class="btn generar" onclick="generarScript()">Generar Script</button>
            <button type="button" class="btn ejecutar" onclick="ejecutarEnPostgreSQL()">Ejecutar en PostgreSQL</button>
        </div>
    </div>
    <!-- Div para mostrar la tabla de tokens -->
    <div id="resultado-analisis" class="table-box tables-container"></div>
{% endif %}

<script>
    function analizarCodigo() {
        const code = document.getElementById("texto-completo").innerText;
    
        fetch("/analizar", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({ code })
        })
        .then(response => response.json())
        .then(data => {
            const resultadoDiv = document.getElementById("resultado-analisis");
            resultadoDiv.innerHTML = ""; 
            
            if (data.tokens && data.tokens.length > 0) {
                // Renderizar la tabla de tokens
                let tableHTML = '<table class="tabla-tokens"><tr><th>Línea</th><th>Tipo</th><th>Valor</th></tr>';
                
                data.tokens.forEach(token => {
                    tableHTML += `<tr><td>${token[0]}</td><td>${token[1]}</td><td>${token[2]}</td></tr>`;
                });
                
                tableHTML += "</table>";
                resultadoDiv.innerHTML = tableHTML;
            } else {
                resultadoDiv.innerHTML = "<p>No se encontraron tokens en el análisis.</p>";
            }
        })
        .catch(error => {
            console.error("Error en el análisis:", error);
            document.getElementById("resultado-analisis").innerHTML = "<p>Error al analizar el código.</p>";
        });
    }
    

    function enviarCodigoCompleto() {
        // Obtener el contenido de cada caja de texto
        const codigo1 = document.querySelector('textarea[name="codigo1"]').value;
        const codigo2 = document.querySelector('textarea[name="codigo2"]').value;
        const codigo3 = document.querySelector('textarea[name="codigo3"]').value;
        const codigo4 = document.querySelector('textarea[name="codigo4"]').value;
    
        // Combinar el contenido en una sola variable
        const codigoCompleto = `${codigo1}\n${codigo2}\n${codigo3}\n${codigo4}`;
    
        // Mostrar el cuadro blanco con el contenido combinado
        const cuadroBlanco = document.getElementById("cuadro-blanco");
        const textoCompleto = document.getElementById("texto-completo");
        textoCompleto.innerText = codigoCompleto;
        cuadro
        Blanco.style.display = "block";
    }

    function enviarParte(parte) {
        // Obtener el contenido de la caja de texto específica
        const textarea = document.querySelector(`textarea[name="${parte}"]`);
        const contenido = textarea.value;
    
        // Obtener el cuadro blanco y el elemento donde se muestra el texto completo
        const cuadroBlanco = document.getElementById("cuadro-blanco");
        const textoCompleto = document.getElementById("texto-completo");
    
        // Agregar el contenido al cuadro blanco
        textoCompleto.innerText += contenido + "\n";
    
        // Mostrar el cuadro blanco si no está visible
        cuadroBlanco.style.display = "block";
    }

    // Función para borrar el contenido de la caja de texto específica
function borrarParte(parte) {
    const textarea = document.querySelector(`textarea[name="${parte}"]`);
    textarea.value = ''; // Borrar el contenido de la caja de texto
}

// Función para borrar todo el contenido del cuadro blanco y del análisis
function borrarScript() {
    document.getElementById("texto-completo").innerText = "";
    document.getElementById("resultado-analisis").innerHTML = "";
}

</script>
            
        </div>
        <div class="db-icon">
            <img src="{{ url_for('static', filename='img/bd.png') }}" alt="Icono de base de datos" class="animate-image">
        </div>        
</main>    
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>